---
title: "Demand Charge and Forecasts"

author: "Yohan Min"
  
date: "Updated `r Sys.Date()`"

output:
  bookdown::gitbook:
    config:
      toc:
        collapse: no
        scroll_highlight: yes
        before: null
        after: null
      toolbar:
        position: fixed
      edit : null
      download: yes
      search: yes
      fontsettings:
        theme: white
        family: sans
        size: 2
    sharing:
      facebook: yes
      twitter: yes
      google: no
      linkedin: no
    all: ['facebook', 'google', 'twitter', 'linkedin']

---

<!-- Packages -->
```{r include = FALSE}
lapply(c("readr","dplyr","tidyr","ggplot2","broom","stringr","kableExtra","forecast","demand","quantmod","corrplot"), require, character.only = TRUE)

options(scipen=10)

knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

# Executive Summary {#index}

This package creates diverse plots per day, weekday, month and year for peak demand power consumption of several meters to support a [project, demand_acep](https://github.com/demand-consults/demand_acep), which was developed to make raw data of electricity consumption of 4 meters in Poker Flat Research Range (PRFR) ready to use for the further analyses. These plots lead to benefit-cost analyses and cost saving plots based on [electricity rate structure from GVEA](http://www.gvea.com/rates/rates) in Alaska. 

> Poker Flat Research Range (PFRR) is located about 40 miles North of Fairbanks, AK and serves as a sounding rocket launch facility and for other geophysical research activities. PFRR is operated by the University of Alaska Fairbanks (UAF) under contract with NASA. 


<table class="table table-striped table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<caption>Rate schedule</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> Service Type </th>
   <th style="text-align:right;"> Customer Charge [$/month] </th>
   <th style="text-align:right;"> Utility Charge [$/kWh] </th>
   <th style="text-align:right;"> Fuel &amp; Purchased Power Charge [$/kWh] </th>
   <th style="text-align:right;"> Demand Charge [$/kW] </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Residential </td>
   <td style="text-align:right;"> 17.5 </td>
   <td style="text-align:right;"> 0.11631 </td>
   <td style="text-align:right;"> 0.09207 </td>
   <td style="text-align:right;"> 0.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> GS-1 </td>
   <td style="text-align:right;"> 20.0 </td>
   <td style="text-align:right;"> 0.11528 </td>
   <td style="text-align:right;"> 0.09207 </td>
   <td style="text-align:right;"> 0.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> GS-2(S) </td>
   <td style="text-align:right;"> 30.0 </td>
   <td style="text-align:right;"> 0.06256 </td>
   <td style="text-align:right;"> 0.09207 </td>
   <td style="text-align:right;"> 14.29 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> GS-2(P) </td>
   <td style="text-align:right;"> 30.0 </td>
   <td style="text-align:right;"> 0.06256 </td>
   <td style="text-align:right;"> 0.09207 </td>
   <td style="text-align:right;"> 14.29 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> GS-3 </td>
   <td style="text-align:right;"> 295.0 </td>
   <td style="text-align:right;"> 0.02940 </td>
   <td style="text-align:right;"> 0.09207 </td>
   <td style="text-align:right;"> 22.86 </td>
  </tr>
</tbody>
</table>


In addition, this package forecasts peak power demand using ARIMA on a daily and monthly basis. Correlation and a simple regression are also included. 


To use ths package, follow the steps:

1. Install `devtools`
```
install.packages("devtools")
```

2. Load the package 
```
library(devtools)
```

3. Install this package `demand`
```
install_github("reconjohn/demand")
```

3. Load the package 
```
library(demand)
```

Now you are all set!

## Brief description of demand charge using R package, `demand`

Using R package `demand`, peak demand, correlation, forecast, and demand charge were plotted. Refer to the followings for more details about demonstration of code from `demand` package and its results. 

* Peak demand plot for the 4 meters  [here](https://github.com/demand-consults/demand_acep/blob/master/demand/scripts/plots.md) and 
[code](https://github.com/demand-consults/demand_acep/blob/master/demand/scripts/plots.Rmd)

* Peak demand correlation and forecasts [here](https://github.com/demand-consults/demand_acep/blob/master/demand/scripts/forecast.md) and 
[code](https://github.com/demand-consults/demand_acep/blob/master/demand/scripts/forecast.Rmd)

* Demand charge reduction by implementing a virtual meter [here](https://github.com/demand-consults/demand_acep/blob/master/demand/scripts/charge_filled.md) and
[code](https://github.com/demand-consults/demand_acep/blob/master/demand/scripts/charge_filled.Rmd)



View the project [here](https://github.com/demand-consults/demand_acep).

---

To the extent possible under law,
[Yohan Min](https://github.com/reconjohn)
has waived all copyright and related or neighboring rights to
&ldquo;[R package demand](https://github.com/reconjohn/demand)&rdquo;.
This work is published from the United States.


# Demand Charge Power (kW) Plots {#plot}

For each meter (PQ, Wat1, Wat2, and Wat3), there are four plots showing the power (kW) trends per years, months, weekdays and days to help comparing the trends (Nov. 2017 to Apr. 2019)

* Power (kW) trend of a day for days (Day 1 to Day 31) per month 
* Power (kW) trend of a day for weekdays (Sunday to Saturday) per month
* Power (kW) trend of a day for months (Jan. to Dec.) per year
* Power (kW) trend of a month for months (Jan. to Dec.) per year


```{r}

data <- data_plot("../data/tidy_downsampled.csv")
 
```

## PQ

### Power (kW) trend of a day for days (Day 1 to Day 31) per month 

```{r}

day_plot(data, "PQ", "month", "month", "day")
 
```

### Power (kW) trend of a day for weekdays (Sunday to Saturday) per month

```{r}

day_plot(data, "PQ", "day", "month", "weekday")
```

### Power (kW) trend of a day for months (Jan. to Dec.) per year

```{r}
day_plot(data, "PQ", "day", "year", "month")
```

### Power (kW) trend of a month for months (Jan. to Dec.) per year

```{r}
month_plot(data, "PQ")

```

## Wat 1

### Power (kW) trend of a day for days (Day 1 to Day 31) per month 

```{r fig.height= 12, fig.width= 15}

day_plot(data, "Wat1", "month", "month", "day")
```

### Power (kW) trend of a day for weekdays (Sunday to Saturday) per month

```{r}

day_plot(data, "Wat1", "day", "month", "weekday")
```

### Power (kW) trend of a day for months (Jan. to Dec.) per year

```{r}

day_plot(data, "Wat1", "day", "year", "month")
```

### Power (kW) trend of a month for months (Jan. to Dec.) per year

```{r}
month_plot(data, "Wat1")


```


## Wat 2

### Power (kW) trend of a day for days (Day 1 to Day 31) per month 

```{r fig.height= 12, fig.width= 15}
day_plot(data, "Wat2", "month", "month", "day")
 
```

### Power (kW) trend of a day for weekdays (Sunday to Saturday) per month

```{R}

day_plot(data, "Wat2", "day", "month", "weekday")
```

### Power (kW) trend of a day for months (Jan. to Dec.) per year

```{r}


day_plot(data, "Wat2", "day", "year", "month")
```

### Power (kW) trend of a month for months (Jan. to Dec.) per year

```{r}
month_plot(data, "Wat2")

```

## Wat 3

### Power (kW) trend of a day for days (Day 1 to Day 31) per month 

```{r fig.height= 12, fig.width= 15}

day_plot(data, "Wat3", "month", "month", "day")
```

### Power (kW) trend of a day for weekdays (Sunday to Saturday) per month

```{r}
day_plot(data, "Wat3", "day", "month", "weekday")

```

### Power (kW) trend of a day for months (Jan. to Dec.) per year

```{r}
day_plot(data, "Wat3", "day", "year", "month")

```

### Power (kW) trend of a month for months (Jan. to Dec.) per year

```{r}
month_plot(data, "Wat3")
```


# Power Forecast

## Power (kW) for demand charge correlation

These 4 meters have power (kW) correlated each other for the past 3 years. The correlations are various depending upon the comparisons. In general, power in `PQ` meter is mostly correlated with power in `Wat3`. This founding is interesting as the more correlated, the more dependency resulting in less effective to address load reduction of having a virtual meter, are expected. 

```{r}

data <- cor_reg("../data/15m_downsampled.csv")[[1]]
fit <- cor_reg("../data/15m_downsampled.csv")[[2]]
```

## Past 3 years power trends of each meter (Nov. 2017 to Apr. 2019)

Variances of power (kW) for each meter, verify the correlations found in the previous correlation plot.

```{r}

plot(data, multi.panel=4, grid.ticks.lwd=0)
```


A regression model for power of `PQ` shows `Wat3` is the most significant followed by `Wat2` resulting in 0.72 in adjusted R-squared. They are higly correlated. 

```{r}

fit %>% tidy() %>% 
  mutate_if(is.numeric, round, digits=2) %>%
  kable(caption = "PQ power (kW) regression in Wat1, Wat2 and Wat3") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = T,
                position = "center") 

```



## Forecast based on month

Using ARIMA, power trends of each meter were forecasted based on month, which is the billing cycle for demand charge. The power trends were plotted with maximum value of the peack power during the month because the peak power decides the billing cost. 

### PQ

It was expected that power for PQ would be around 125 kW for the last 3 months and the real values for these months were 114, 107, and 131 kW respectively. 


#### Montly maximum peak power(kW) trend

```{r}
month_peak <- read_csv(file = "../data/month_downsampled.csv") 
peak_power(month_peak, "PQ")
```

#### Density of maximum peak power (kW)

The density plot shows the distribution of the monthly peak power for each meter. For `PQ`, peak power around 125 kW is mostly prevalent, which means there is more probability that `PQ` peak power would be around 125 kW. 

```{r}

den_plot(month_peak, "PQ")
```


#### Prediction performance for the last 3 months

ARIMA predicted the peak power for the last 3 months, which is February, March, and April given the previous peak power data from November, 2017 to January, 2019. Since there are 2 months missing (November and December of 2018), the months used for the prediction were 13 months. Given the historical data of 13 months, the model predicts the coming 3 months and it is quite accurate as around 125 kW compared to the real values for these months, 114, 107, and 131 kW respectively. 



```{r}

arima_month(month_peak, "PQ", 13)

```


### Wat1

It was expected that power for Wat1 would be around 372 kW for the last 3 months and the real values for these months were 385, 377, and 370 kW respectively. 

#### Montly maximum peak power(kW) trend

```{r}

peak_power(month_peak, "Wat1")
```


#### Density of maximum peak power (kW)

```{r}
den_plot(month_peak, "Wat1")
```

#### Prediction performance for the last 3 months

```{r}

arima_month(month_peak, "Wat1", 13)

```

### Wat2

It was expected that power for Wat2 would be around 18 kW for the last 3 months and the real values for these months were 20, 19, and 17 kW respectively. 

#### Montly maximum peak power(kW) trend

```{r}

peak_power(month_peak, "Wat2")
```


#### Density of maximum peak power (kW)

```{r}

den_plot(month_peak, "Wat2")
```

#### Prediction performance for the last 3 months

```{r}

arima_month(month_peak, "Wat2", 13)

```

### Wat3

It was expected that power for Wat3 would be around 68 kW for the last 3 months and the real values for these months were 89, 52, and 85 kW respectively. 

#### Montly maximum peak power(kW) trend

```{r}
peak_power(month_peak, "Wat3")
```


#### Density of maximum peak power (kW)

```{r}

den_plot(month_peak, "Wat3")
```

#### Prediction performance for the last 3 months

```{r}
arima_month(month_peak, "Wat3", 13)

```


## Forecast based on day

For the comparison, forecastes based on day, were also plotted. The range between the upper and lower bound of forecast shows narrower than the one based on month. 

### PQ

#### Daily maximum peak power(kW) trend

```{r}
day_peak <- read_csv(file = "../data/day_downsampled.csv")
peak_power(day_peak, "PQ")
```


#### Density of maximum peak power (kW)

```{r}

den_plot(day_peak, "PQ")
```

#### Prediction performance for the last 10 days

There are total 413 days previously available since November 2017 till April 2019. Given the 404 days, rest of 10 days were predicted from 405th day to 413th day as below in the figure. 

```{r}

arima_day(day_peak, "PQ", 404)

```


### Wat1


#### Daily maximum peak power(kW) trend

```{r}
peak_power(day_peak, "Wat1")
```


#### Density of maximum peak power (kW)

```{r}

den_plot(day_peak, "Wat1")
```

#### Prediction performance for the last 10 days

```{r}

arima_day(day_peak, "Wat1", 404)

```


### Wat2


#### Daily maximum peak power(kW) trend

```{r}

peak_power(day_peak, "Wat2")
```


#### Density of maximum peak power (kW)

```{r}
den_plot(day_peak, "Wat2")
```

#### Prediction performance for the last 10 days

```{r}
arima_day(day_peak, "Wat2", 404)

```

### Wat3


#### Daily maximum peak power(kW) trend

```{r}

peak_power(day_peak, "Wat3")
```


#### Density of maximum peak power (kW)

```{r}

den_plot(day_peak, "Wat3")
```

#### Prediction performance for the last 10 days

```{r}

arima_day(day_peak, "Wat3", 404)

```


# Demand Charge Analysis 


## Total aggregated power (kW) for demand charge based on month

The aggregated total power (kW) on a monthly basis will show the trend of peak demand power over the past 3 years. This will help to analyze the effect of a virtual meter by comparing the separate billing of the four meters and the aggregated billing of the virtual meter. 

Using ARIMA, the trend of aggregated meter powers were forecasted based on month, which is the billing cycle for demand charge. The power trends were plotted with maximum value of the peak power during the month because the peak power decides the billing cost.


It turns out having a virtual meter by aggregating all the power consumptions of all four meters, reduces the peak demand as shown in the Figure below. Every month has less peak demand by a virtual meter compared to summing up all the peak demand of the individual meters during a billing cycle. 


### Montly maximum peak power(kW) trend

```{r}
data <- read_csv(file = "../data/charge_downsampled.csv") %>% 
  mutate(time = as.Date(time, format="%m/%d/%Y"))
peak_compare(data)

```


### Density of maximum peak power (kW)

The figure below shows by having a virtual meter, the peak demand density becomes lower. It shows the distribution of peak power or probability that what value of peak power (kW) is highly expected for the cases of a virtual meter scenario and the total of the individual 4 meters. It shows that having a virtual meter reduced the probability of higher peak power across months. 

```{r}
den_compare(data)
```

### Prediction performance for the last 3 months

There are slightly difference between monthly peak demand forecasts of a virtual meter and aggregated four meters. 

```{r}

arima_month(data, "Virtual_meter", 15)
  
```

```{r}

arima_month(data, "Total_4meters", 15)

```


## Benefit-cost analysis of involving a virtual meter

A virtual meter could save money by aggregating all the meters resulting in a payment once during a billing cycle as opposed to several billed payments, in this case four times. On the other hand, vitual meter may lead to higher rate per unit kW for the demand charge. For example, the utility has charged `Poker flat` \$14.29 per kW for GS-2 service while GS-3 would involve \$22.89 per kW. So it is necessary to perform a benefit-cost analysis to find if saving could happen by implementing a virtual meter. 

On the other hand, GS-3 service has higher utility charge of \$0.0294 per kWh while GS-2 has \$0.06256 per kWh. The monthly power consumption for each meter and the total are shown in the figure below. Note that the energy consumption value is for each month in order since November 2017 to April 2019. 

```{r}
chrg <- cost_table(data)
energy_compare_plot(data)
```

Adding customer charge and fuel & purchased power charge, which are fixed during a month, the total estimated electricity costs for the both cases (1) payments for the individual 4 meters, and (2) a payment for the virtual meter, were caculated. 

```{r}
read_csv(file = "../data/charge_rate.csv") %>%
  kable(caption = "Rate schedule") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = T,
                position = "center") 
  

```


It turns out aggregating all the meters by a virtual meter ends up with paying less with less peak power during a billing cycle as opposed to the aggregation of the peak power of the individual four meters. Note that a specific month has a negative saving meaning that the virtual meter option loses money. It is interesting to see that it would be more beneficial to have a virtual meter when higher energy consumption (kWh) is expected leading to more profitable option. The highest saving would be \$`r round(max(chrg$saving),1)` on `r str_replace(chrg[[which(chrg$saving == max(chrg$saving)), 1]], "-01", "")` and the lowest, \$`r round(min(chrg$saving),2)` on `r str_replace(chrg[[which(chrg$saving == min(chrg$saving)), 1]], "-01", "")`, where the negative saving is due to the lower energy consumption on the month resulting from data missing. 

```{r}

monthly_bill(data)

```

The saving distribution is as below showing the most savings would occur between \$4,000 to \$7,000 a month. 

```{r}
saving_distribution(data)

```



The estimated average montly saving would be \$`r round(sum(chrg$saving)/16, 2)` due to its skewness to left. So the conclusion is having a vurtaul meter is viable and saving money by reducing the billing. 

* Note that the last month in the data, which is April of 2019, has only 10 days data available so the values are relatively lower than other months. 

* There were missing months such as November and December of 2018, and missing days specially in September, 2018 so data filling technique was performed with the fact that this doesn't invole bias result. 

* Nontheless, for the purpose of comparison of the both cases (a virtual meter, and 4 meters), missing or filling data won't be an issue as it applies the same to the both cases and still make the cases comparable.


